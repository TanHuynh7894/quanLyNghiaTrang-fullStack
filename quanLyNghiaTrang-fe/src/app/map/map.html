<div class="map-controls-container">
  <div class="map-container">
    <div #map class="map-app"></div>
    <!-- DETAIL OVERLAY (glass) -->
    <div *ngIf="detailHtml as d" class="glass-overlay" (mouseenter)="pauseAuto()" (mouseleave)="resumeAuto()">
      <button class="glass-close" (click)="closeDetailOverlay()" aria-label="ƒê√≥ng">√ó</button>

      <div class="glass-modal">
        <h1 class="glass-title">Chi ti·∫øt d·ª± √°n</h1>

        <div class="glass-grid">
          <!-- Pills -->
          <div class="pill-grid">
            <div class="pill">
              <div class="pill-label">M√£</div>
              <div class="pill-value">{{ d.dia_chi }}</div>
            </div>
            <div class="pill">
              <div class="pill-label">Lo·∫°i</div>
              <div class="pill-value">{{ d.mo_phan?.ten_kieu_mo || '‚Äî' }}</div>
            </div>
            <div class="pill pill-wide">
              <div class="pill-label">Tr·∫°ng th√°i</div>
              <div class="pill-value uppercase">{{ d.mo_phan?.ten_tinh_trang || '‚Äî' }}</div>
            </div>
            <div class="pill pill-wide">
              <div class="pill-label">Gi√°</div>
              <div class="pill-value">{{ d.mo_phan?.gia_tri ? (d.mo_phan?.gia_tri | number:'1.0-0')+' ‚Ç´' : 'Li√™n h·ªá' }}
              </div>
            </div>
          </div>

          <!-- ·∫¢nh l·ªõn + ƒëi·ªÅu h∆∞·ªõng -->
          <div class="image-card">
            <div class="image-frame">
              <img *ngIf="(d.hinh_anh_mo_phan?.length||0)>0; else noImg"
                [src]="mediaBaseUrl + d.hinh_anh_mo_phan[galleryIndex]?.hinh_anh" alt="·∫¢nh m·ªô ph·∫ßn" />
              <button *ngIf="d.hinh_anh_mo_phan?.length>1" class="nav left" (click)="prevImg()">‚Äπ</button>
              <button *ngIf="d.hinh_anh_mo_phan?.length>1" class="nav right" (click)="nextImg()">‚Ä∫</button>
            </div>
          </div>
        </div>

        <button class="cta">ƒê·∫∂T MUA NGAY</button>

        <div class="detail-section">
          <h3 class="section-title">Th√¥ng tin chi ti·∫øt</h3>
          <div class="info-items-grid">
            <div class="info-item">
              <span class="info-icon">üìç</span>
              <div class="info-content">
                <span class="info-label">V·ªã tr√≠</span>
                <p>Khu {{ d.ten_khu }} ¬∑ H√†ng {{ d.ten_hang }} ¬∑ √î {{ d.ten_o }}</p>
              </div>
            </div>
            <div class="info-item">
              <span class="info-icon">üìè</span>
              <div class="info-content">
                <span class="info-label">K√≠ch th∆∞·ªõc (D√†i x R·ªông)</span>
                <p>{{ d.mo_phan?.chieu_dai }}m √ó {{ d.mo_phan?.chieu_rong }}m</p>
              </div>
            </div>
            <div class="info-item">
              <span class="info-icon">üìê</span>
              <div class="info-content">
                <span class="info-label">Di·ªán t√≠ch</span>
                <p>{{ d.mo_phan?.dien_tich }}m¬≤</p>
              </div>
            </div>
            <div class="info-item">
              <span class="info-icon">üìÖ</span>
              <div class="info-content">
                <span class="info-label">Ng√†y kh·∫£o s√°t</span>
                <p>{{ d.mo_phan?.ngay_khao_sat | date:'longDate' }}</p>
              </div>
            </div>
          </div>
        </div>

        <div class="detail-section" *ngIf="d.lich_su_mo_phan?.length">
          <h3 class="section-title">L·ªãch s·ª≠ m·ªô ph·∫ßn</h3>
          <ul class="timeline">
            <li *ngFor="let ls of d.lich_su_mo_phan" class="timeline-item">
              <div class="timeline-date">{{ ls.ngay | date:'mediumDate' }}</div>
              <div class="timeline-content">
                <strong>{{ ls.the_loai }}</strong>
                <p>{{ ls.ghi_chu }}</p>
              </div>
            </li>
          </ul>
        </div>

        <ng-template #noImg>
          <div class="image-placeholder">Kh√¥ng c√≥ ·∫£nh</div>
        </ng-template>
      </div>

    </div>
    <div class="legend-ttmp" *ngIf="showLegendTtmp">
      <div class="legend-title">T√¨nh tr·∫°ng m·ªô ph·∫ßn</div>

      <div class="legend-row" *ngFor="let tt of tinhTrangList">
        <input 
          type="checkbox" 
          [checked]="tt.checked" 
          (change)="onTinhTrangToggle(tt)" 
          class="legend-checkbox" />
        <span class="swatch" [style.background]="tt.color || '#FFFFFF'"></span>
        <span class="label">{{ tt.ten_tinh_trang }}</span>
      </div>
    </div>

    <ng-template #legendFallback>
      <div class="legend-ttmp">
        <div class="legend-title">T√¨nh tr·∫°ng m·ªô ph·∫ßn</div>
        <div *ngIf="tinhTrangLoading">ƒêang t·∫£i‚Ä¶</div>
        <div *ngIf="!tinhTrangLoading && tinhTrangError">{{ tinhTrangError }}</div>
        <div *ngIf="!tinhTrangLoading && !tinhTrangError">Kh√¥ng c√≥ d·ªØ li·ªáu</div>
      </div>
    </ng-template>

  </div>