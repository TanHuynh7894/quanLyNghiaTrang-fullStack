<header class="app-header">
  <!-- Left: menu toggle -->
  <div class="header-left">
    <button
      type="button"
      class="menu-toggle-button"
      [class.close-style]="isMenuOpen"
      (click)="toggleMenu()"
      aria-label="Toggle menu"
    >
      <span *ngIf="!isMenuOpen">☰</span>
      <span *ngIf="isMenuOpen">&times;</span>
    </button>
  </div>

  <!-- CENTER: search / record -->
  <div class="gmaps-search" role="search">
    <!-- chế độ SEARCH -->
    <ng-container *ngIf="!isRecordingMode; else recordingTpl">
      <input
        id="map-search"
        type="text"
        placeholder="khu-hang-o"
        autocomplete="off"
        aria-label="Search places"
        [(ngModel)]="query"
        (keyup.enter)="onSearch()"
      />

      <!-- nút search -->
      <button class="icon-btn" type="button" aria-label="Search" (click)="onSearch()">
        <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M11 19a8 8 0 1 1 5.292-14.02A8 8 0 0 1 11 19z" fill="none" stroke="currentColor" stroke-width="2"/>
          <path d="M21 21l-4.3-4.3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>

      <!-- MIC: start recording -->
      <button
        type="button"
        class="icon-btn mic"
        aria-label="Start recording"
        [class.is-uploading]="isUploading"
        (click)="onMicClickStart()"
      >
        <ng-container *ngIf="!isUploading; else uploadingTpl">
          <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3Z" fill="currentColor"/>
            <path d="M5 11a7 7 0 0 0 14 0" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 18v3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </ng-container>
      </button>
    </ng-container>

    <!-- chế độ GHI ÂM -->
    <ng-template #recordingTpl>
      <!-- Trash (trái) -->
      <button
        type="button"
        class="icon-btn trash"
        aria-label="Cancel recording"
        (click)="onCancelRecording()"
        [disabled]="isUploading"
      >
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3 6h18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M8 6v-2a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" stroke-width="2" fill="none"/>
          <path d="M6 6l1 14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-14" stroke="currentColor" stroke-width="2" fill="none"/>
          <path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>

      <!-- Waveform SVG (giữa) -->
      <svg
        #waveSvg
        class="rec-svg"
        [attr.viewBox]="'0 0 ' + svgW + ' ' + svgH"
        preserveAspectRatio="none"
        aria-label="Đang ghi âm"
      >
        <line class="baseline" [attr.x1]="0" [attr.x2]="svgW" [attr.y1]="centerY" [attr.y2]="centerY"></line>
        <g class="stems">
          <line
            class="stem"
            *ngFor="let _ of stemsArr; let i = index"
            [attr.x1]="i * stemGap + 0.5"
            [attr.x2]="i * stemGap + 0.5"
            [attr.y1]="centerY"
            [attr.y2]="centerY"
          ></line>
        </g>
      </svg>

      <!-- Send (phải) -->
      <button
        type="button"
        class="icon-btn send"
        aria-label="Send voice"
        (click)="onSendRecording()"
        [disabled]="isUploading || elapsedMs < MIN_SEND_MS"
      >
        <ng-container *ngIf="!isUploading; else uploadingTpl">
          <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M22 2 11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="m22 2-7 20-4-9-9-4 20-7z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          </svg>
        </ng-container>
      </button>
    </ng-template>

    <!-- spinner dùng chung -->
    <ng-template #uploadingTpl>
      <span class="spinner" aria-hidden="true"></span>
    </ng-template>
  </div>

  <!-- OPTIONS: khu / hàng / ô -->
  <div class="gmaps-options">
    <select class="dropdown" [(ngModel)]="selectedKhu" (change)="onKhuChange()" aria-label="Chọn khu">
      <option value="" disabled [selected]="!selectedKhu">Chọn khu</option>
      <option *ngFor="let k of khus" [value]="k">{{ k }}</option>
    </select>

    <select class="dropdown" [(ngModel)]="selectedHang" (change)="onHangChange()" [disabled]="!selectedKhu" aria-label="Chọn hàng">
      <option value="" disabled [selected]="!selectedHang">Chọn hàng</option>
      <option *ngFor="let h of hangs" [value]="h">{{ h }}</option>
    </select>

    <select class="dropdown" [(ngModel)]="selectedO" (change)="onOChange()" [disabled]="!selectedHang" aria-label="Chọn ô">
      <option value="" disabled [selected]="!selectedO">Chọn ô</option>
      <option *ngFor="let o of os" [value]="o">{{ o }}</option>
    </select>
  </div>

  <!-- Right: title -->
  <div class="header-right">
    <div class="project-title">{{ projectName }}</div>
  </div>

  <!-- error -->
  <p class="error" *ngIf="recordError">Lỗi thu âm: {{ recordError }}</p>
</header>
